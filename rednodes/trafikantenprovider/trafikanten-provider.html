<script type="text/javascript">
    RED.nodes.registerType('trafikanten-provider',{
        category: 'input',
        color: '#a6bbcf',
        defaults: {
            name: {value:"trafikanten-provider"}
        },
        oneditprepare: function() {
            console.log("oneditprepare", arguments);
            var head = document.querySelector("head");
            var existingLink = head.querySelector("link[rel='import'][href='/bower_components/vsr-combobox/combobox.html']");
            if (!existingLink) {
                var scriptEl = document.createElement("script");
                scriptEl.setAttribute("src", "/bower_components/platform/platform.js");
//                head.appendChild(scriptEl);
                var linkEl = document.createElement("link");
                linkEl.setAttribute("rel", "import");
                linkEl.setAttribute("href", "/bower_components/vsr-combobox/combobox.html");
//                head.appendChild(linkEl);
            }
            Array.prototype.slice.call(document.querySelectorAll('dialog')).forEach(function(dialog) {
                dialog.addEventListener('close', function() {
                    console.log("Closing dialog", dialog);
                    if (dialog.returnValue === false) {
                        return;
                    }
                    var valueElements = dialog.querySelector("iframe").contentDocument.body.querySelectorAll("*[name]");
                    for (var i = 0; i < valueElements.length; i++) {
                        var valueElement = valueElements[i];
                        var formElement = document.querySelector("#dialog").querySelector("*[name='" + valueElement.name + "']");
                        console.log("formElement =", formElement);
                        if (formElement) {
                            formElement.value = valueElement.value;
                        }
                        console.log("valueElement =", valueElement);
                    }
                });
            });
/*            var stationNameField = document.querySelector("#station-name");
            var stationIdField = document.querySelector("#station-id");
            console.log("stationNameField = " + stationNameField);
            var stationList = document.querySelector("#station-list");
            var lineList = document.querySelector("#line-list");
            var _this = this;
            var lookupStationByName = function(name) {
                stationList.isLookingUp = true;
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/ruter/Place/GetPlaces/" + name);
                xhr.setRequestHeader("Accept", "application/json");
                xhr.responseType = "json";
                xhr.onreadystatechange = function(evt) {
                    if (this.readyState == 4) {
                        stationList.isLookingUp = false;
                        if (this.status == 200) {
                            stationNameField.classList.remove("error");
                            while (stationList.firstElementChild) {
                                stationList.removeChild(stationList.firstElementChild);
                            }
                            var matches = this.response;
                            var selected = false;
                            for (var i = 0; i < matches.length && i < 10; i++) {
                                var match = matches[i];
                                if (match.PlaceType != "Stop") {
                                    continue;
                                }
                                if (!selected) {
                                    stationIdField.value = match.ID;
                                    selected = true;
                                }
                                stationList.innerHTML += "<option value=\"" + match.Name + " (" + match.District + ")" +"\">" + match.ID +"</option>";
                            }
                        } else {
                            stationNameField.classList.add("error");
                            stationNameField.title = "Error: " + this.statusText;
                        }
                    }
                };
                xhr.send();
            };
            stationNameField.addEventListener("keyup", function(evt) {
                console.log("this.value =", this.value);
                var now = new Date().getTime();
                if ((!stationList.lastLookup || stationList.lastLookup + 1000 < now)
                        && !stationList.isLookingUp
                        && this.value.length > 2) {
                    stationList.lastLookup = now;
                    lookupStationByName(this.value);
                }
            }, false);*/
        },
        inputs:1,
        outputs:1,
        icon: "file.png",
        label: function() {
            return this.name||"trafikanten-provider";
        }
    });
    debugger;
/*
    stationNameField.addEventListener("change", function(evt) {
        console.log(stationNameField.value);
    }, false);
*/
</script>

<script type="text/x-red" data-template-name="trafikanten-provider">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
        <label for="station-name"><i class="icon-tag"></i>Station</label>
        <input type="text" id="station-name" name="stationName" list="station-list" readonly >
        <input type="text" id="station-id" name="station-id" placeholder="Station ID" readonly/>
        <dialog id="minDialog">
            <iframe frameborder="0" src="/trafikantenprovider/test.html" width="200" height="200"></iframe>
            <button type="button" onclick="document.querySelector('#minDialog').close()">OK</button>
            <button type="button" onclick="document.querySelector('#minDialog').close(false)">Avbryt</button>
        </dialog>
        <button type="button" onclick="document.querySelector('#minDialog').showModal()">Ã…pne</button>
        <input type="text" id="line-name" name="lineName" list="line-list" placeholder="Line" autocomplete="off">
        <datalist id="line-list">
        </datalist>
    </div>
</script>

<script type="text/x-red" data-help-name="trafikanten-provider">
    <p>A simple node that converts the message payloads into all lower-case characters</p>
</script>