<script type="text/javascript">
    RED.nodes.registerType('prioritizer',{
        category: 'function',
        color: '#a6bbcf',
        inputs:1,
        outputs:1,
        icon: "function.png",
        defaults: {
            numberOfInputs: {value: 0, required: true},
            priorities: {value: [], required: true}
        },

        label: function() {
            return this.name||"Prioritize messages from " + (this.numberOfInputs > 0 ? "" : "X") + " sources";
        },

        oneditprepare: function() {
            console.log("Her er vi. this: ", this, "RED: ", RED);
            console.log("Totalt " + RED.nodes.links.length + " lenker");
            console.log("Vår ID: " + this.id);
            var $prioritySortable = $(".priority-sortable");
            var sourceNodeToElement = function(sourceNode) {
                $prioritySortable.append("<li class=\"ui-state-default\" id=\"" + sourceNode.id + "\">"
                + "<span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>"
                + sourceNode._def.label.call(sourceNode)
                + "</li>");
            };
            var _this = this;
            var sourceNodes = [];
            for (var i = 0; i < RED.nodes.links.length; i++) {
                var link = RED.nodes.links[i];
                if (link.target.id == this.id) {
                    console.log("Vi får en link fra " , link.source);
                    var sourceNode = RED.nodes.node(link.source.id);
                    console.log("Label: ", sourceNode._def.label.call(sourceNode));
                    sourceNodes.push(sourceNode);
                }
            }
            sourceNodes.sort((function(sourceNodeA, sourceNodeB) {
                debugger;
                var aPos = _this.priorities.indexOf(sourceNodeA.id);
                var bPos = _this.priorities.indexOf(sourceNodeB.id);
                return (aPos == -1 ? Number.MAX_VALUE : aPos) - (bPos == -1 ? Number.MAX_VALUE : bPos);
            }));
            for (var i = 0; i < sourceNodes.length; i++) {
                sourceNodeToElement(sourceNodes[i]);
            }
            $prioritySortable.sortable();
        },

        oneditsave: function() {
            this.priorities = $(".priority-sortable").sortable("toArray");
        }
    });
</script>

<script type="text/x-red" data-template-name="prioritizer">
     <style type="text/css">
       .priority-sortable { list-style-type: none; margin: 0; padding: 0; width: 90%; }
       .priority-sortable li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.4em; height: 18px; overflow: ellipse }
       .priority-sortable li span { position: absolute; margin-left: -1.3em; }
     </style>
     <div class="form-row">
       <ul class="priority-sortable">

       </ul>
     </div>

</script>

<script type="text/x-red" data-help-name="prioritizer">
    <p>Prioritize messages</p>
</script>